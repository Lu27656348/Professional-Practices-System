import { formatDate } from '@angular/common';
import { Component,OnInit,Inject } from '@angular/core';
import { FormBuilder, Validators } from '@angular/forms';
import { MAT_DIALOG_DATA } from '@angular/material/dialog';
import { MatSnackBar, MatSnackBarHorizontalPosition, MatSnackBarVerticalPosition } from '@angular/material/snack-bar';
import { Observable, forkJoin, of, switchMap } from 'rxjs';
import { EvaluationFormGeneratorService } from 'src/app/form-generator/services/evaluation-form-generator.service';
import { ResponseBlob } from 'src/app/interfaces/ResponseBlob';
import { EvaluateIntershipProposalRequest } from 'src/app/interfaces/requests/EvaluateIntershipProposalRequest';
import { SendEmailRequest } from 'src/app/interfaces/requests/SendEmailRequest';
import { CouncilService } from 'src/app/services/council.service';
import { EmailService } from 'src/app/services/email.service';
import { EnterpriseService } from 'src/app/services/enterprise.service';
import { GraduateworkService } from 'src/app/services/graduatework.service';
import { PasantiaService } from 'src/app/services/pasantia/pasantia.service';
import { ProfessorsService } from 'src/app/services/professors.service';
import { UsersService } from 'src/app/services/users.service';
import { environment } from 'src/environments/environment';

async function descargarPropuestaPasantia(fileName: string,studentDNI: string, userFirstName: string, userLastName: string,schoolName: string) {
  try {
    const response = await fetch(`${environment.amazonS3}/download/pasantia/propuesta`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ fileName: fileName,studentDNI: studentDNI, userFirstName: userFirstName, userLastName: userLastName,escuela:schoolName})
    } as RequestInit);

    const blob = await (response as ResponseBlob<Blob>).blob(); // Type assertion for blobBody
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = fileName; // Set desired filename
    link.click();
  } catch (error) {
    console.error('Error downloading file:', error);
  }
}


@Component({
  selector: 'app-evaluate-pasantia-dialog',
  templateUrl: './evaluate-pasantia-dialog.component.html',
  styleUrls: ['./evaluate-pasantia-dialog.component.css']
})
export class EvaluatePasantiaDialogComponent implements OnInit{

  professorList: any = null;
  councilList: any = null;

  pasantiaForm;

  inputdata: any = null;

  studentData: any = null;
  corporateTutorData: any = null;
  academicTutorData: any = null;
  enterpriseData: any = null;
  schoolCouncilData: any = null;
  administratorData: any = null;
  intershipData: any = null;

  studentNotification: any = null;
  tutorNotification: any = null;

  fechaCulminacion: any = null
  fechaIniciacion: any = null

  horizontalPosition: MatSnackBarHorizontalPosition = "right";
  verticalPosition: MatSnackBarVerticalPosition = 'bottom';

  cargadoArchivos: boolean = false

  formatDate(date: Date): string {
    const options: Intl.DateTimeFormatOptions = {
      year: "numeric",
      month: "long",
      day: "numeric",
    };
  
    const locale = "es-ES"; // Cambiar segÃºn el idioma deseado
  
    return date.toLocaleDateString(locale, options);
  }

  constructor(
    private professorService: ProfessorsService, 
    private userService: UsersService, 
    private formBuilder: FormBuilder, 
    private councilService: CouncilService,
    private enterpriseService: EnterpriseService,
    private pasantiaService: PasantiaService,
    private _snackBar: MatSnackBar,
    private emailService: EmailService,
    private formGenerator: EvaluationFormGeneratorService,
    @Inject(MAT_DIALOG_DATA) public data: any
  ){
    this.pasantiaForm = this.formBuilder.group({
      tutorAcademico: ['', Validators.required],
      consejoEscuela: ['', Validators.required]
    })

    this.inputdata = data;
    console.log(this.inputdata)

    this.fechaCulminacion = this.formatDate(new Date(this.inputdata.pasantia.intershipCompletionDate))
    this.fechaIniciacion = this.formatDate(new Date(this.inputdata.pasantia.intershipStartDate))
    console.log(this.inputdata.pasantia.intershipCompletionDate)
    console.log(this.inputdata.pasantia.intershipStartDate)
    console.log(this.fechaCulminacion)
    console.log(this.fechaIniciacion)
    this.userService.getUserData(this.inputdata.pasantia.studentDNI).pipe(
      switchMap(
        (studentData) => {
          this.studentData = studentData
          return this.pasantiaService.getPasantiaById(this.inputdata.pasantia.intershipId)
        }
      ),
      switchMap( 
        (intershipData) => {
          console.log(intershipData)
          this.intershipData = intershipData
          return this.userService.getUserData(this.inputdata.pasantia.corporateTutorDNI)
        }
      ),
      switchMap(
        (corporateTutorData) => {
          this.corporateTutorData = corporateTutorData
          return this.enterpriseService.getEnterpriseById(this.inputdata.pasantia.enterpriseId)
        }
      ),
    ).subscribe(
      {
        next: (enterpriseData) => {
          this.enterpriseData = enterpriseData
        }
      }
    )
    
    this.councilService.getCouncilsBySchool(this.inputdata.user.schoolName).subscribe({
      next: (councilList) => {
        this.councilList = councilList
      }
    })
  } 

  ngOnInit(): void {
    this.professorService.getProfessors().pipe(
      switchMap(
        (professorDNIList: any) => {
          console.log(professorDNIList)
          const observables: Observable<any>[] = []
          professorDNIList.forEach( (professor: any) => {
            observables.push(this.userService.getUserData(professor.userDNI))
          })
          return forkJoin(observables)
        }
      )
    ).subscribe({
      next: (professorList) => {
        console.log(professorList)
        this.professorList = professorList
      }
    })
  }

  rechazarPropuestaPasantia(){
    if(this.pasantiaForm.value.consejoEscuela){
      this.cargadoArchivos = true
      const evaluationData: EvaluateIntershipProposalRequest = {
        intershipId: this.inputdata.pasantia.intershipId,
        intershipStatusCode: 400,
        schoolCouncilId: this.pasantiaForm.value.consejoEscuela as string,
        schoolCouncilDecision: 'RECHAZADA',
	      corporateTutorDNI: null
      }
      console.log(evaluationData)
      this.pasantiaService.evaluarPropuestaPasantia(evaluationData).subscribe(
        {
          next: (result) => {
            console.log(result)
          },
          complete: () => {
            window.location.href = window.location.href
          }
        }
      )
    }else{
      this._snackBar.open("Debe cargar un consejo de escuela", "cerrar",{
        horizontalPosition: this.horizontalPosition,
        verticalPosition: this.verticalPosition,
      })
    }
    
  }

  aprobarPropuestaPasantia(){
    if(this.pasantiaForm.valid){

      this.cargadoArchivos = true
      this.councilService.getCouncilById(this.pasantiaForm.value.consejoEscuela as string).pipe(
        switchMap(
          (schoolData) => {
            console.log(schoolData)
            this.schoolCouncilData = schoolData;
            console.log(this.inputdata.pasantia)
            console.log(this.pasantiaForm.value)
            return this.userService.getUserData(this.pasantiaForm.value.tutorAcademico as string)
          }
        ),
        switchMap(
          (academicTutorData) => {
            console.log(academicTutorData)
            this.academicTutorData = academicTutorData;
            return this.userService.getUserData(this.inputdata.pasantia.corporateTutorDNI)
          }
        ),
        switchMap(
          (corporateTutorData) => {
            console.log(corporateTutorData)
            this.corporateTutorData = corporateTutorData;
            return this.userService.getUserData(this.inputdata.pasantia.studentDNI)
          }
        ),
        switchMap(
          (studentData) => {
            console.log(studentData)
            this.studentData = studentData;
            const localUser = localStorage.getItem('user');
            if(localUser){
              const localUserData = JSON.parse(localUser)
              console.log(localUserData.userDNI)
              return this.userService.getUserData(localUserData.userDNI)
            }
            return of(
              null
            )
          }
        ),
        switchMap(
          (administratorData) => {
            if(administratorData == null){
              return of(null)
            }
            console.log(administratorData)
            this.administratorData = administratorData;
            /* Armamos la carta de Notificacion para el estudiante */
            const notificationData = {
              consejo: this.pasantiaForm.value.consejoEscuela as string,
              fechaConsejo: new Date(this.schoolCouncilData.schoolcouncildate) as Date,
              propuesta: {
                tutor_academico: {
                  apellidos: this.academicTutorData.userLastName as string,
                  nombres: this.academicTutorData.userFirstName as string
                },
                titulo: this.inputdata.pasantia.intershipTitle as string,
                alumno: {apellidos: this.studentData.userLastName as string, nombres: this.studentData.userFirstName as string}
              },
              fecha_designacion: new Date() as Date,
              revisor: (this.academicTutorData.userLastName + ", " + this.academicTutorData.userFirstName) as string,
              correo_administrador: administratorData.userEmail as string,
              administrador: `${administratorData.userFirstName.split(" ")[0]} ${administratorData.userFirstName.split(" ")[1].charAt(0)}. ${administratorData.userLastName.split(" ")[0]} `
            }
            console.log(notificationData)
            return this.formGenerator.convertDocumentToBlob(this.formGenerator.generateIntershipCorporateTutorNotification(notificationData));
            
          }
        ),
        switchMap(
          (studentNotificationBlob: any) => {
            /* Enviamos la carta por correo electronico  */
            const file: File = new File([studentNotificationBlob], `${this.studentData.userLastName.split(" ")[0]}${this.studentData.userFirstName.split(" ")[0]} NotificaciÃ³n AprobaciÃ³n de PasantÃ­a y Tutor AcadÃ©mico.docx`, { type: studentNotificationBlob.type });
            console.log(file)

            this.studentNotification = file;

            /* Armamos la carta de notificacion para el tutor */

            const academicTutorNotificationData = {
              fechaEnvio: new Date(),
              academicTutor: this.academicTutorData.userLastName + ", " + this.academicTutorData.userFirstName,
              consejoDeEscuela: this.schoolCouncilData.schoolCouncilId,
              fechaConsejo: new Date(this.schoolCouncilData.schoolcouncildate),
              datosEstudiante: {
                  nombre: this.studentData.userLastName + "," + this.studentData.userFirstName,
                  cedula: this.studentData.userDNI
              },
              empresa: this.enterpriseData.enterpriseName as string,
              titulo: this.inputdata.pasantia.intershipTitle,
              fechaInicio: new Date(this.intershipData.intershipStartDate),
              fechaFin: new Date(this.fechaCulminacion),
              tutorEmpresarial: this.corporateTutorData.userLastName + ", " + this.corporateTutorData.userFirstName ,
              administrador: `${this.administratorData.userFirstName.split(" ")[0]} ${this.administratorData.userFirstName.split(" ")[1].charAt(0)}. ${this.administratorData.userLastName.split(" ")[0]} `
            }
            console.log(academicTutorNotificationData)
            return this.formGenerator.convertDocumentToBlob(this.formGenerator.generateIntershipAcademicTutorNotification(academicTutorNotificationData))
          }
        ),
        switchMap(
          (tutorNotification) => {
            const file: File = new File([tutorNotification], `${this.studentData.userLastName.split(" ")[0]}${this.studentData.userFirstName.split(" ")[0]} ${this.academicTutorData.userLastName.split(" ")[0]}${this.academicTutorData.userFirstName.split(" ")[0]} DesignaciÃ³n Tutor AcadÃ©mico PasantÃ­a.docx`, { type: tutorNotification.type });
            console.log(file)
            this.tutorNotification = file
            const observables: Observable<any>[] = []

            let emailData: SendEmailRequest = {
              emailTo: this.studentData.userEmail,
              emailFrom: this.administratorData.userEmail,
              subject: `NotificaciÃ³n AprobaciÃ³n PasantÃ­a y Tutor AcadÃ©mico - Procedimiento - GuÃ­as ${this.studentData.userLastName.split(" ")[0]}, ${this.studentData.userFirstName.split(" ")[0]}` ,
              htmlContent: 
              `
              Puerto Ordaz, ${new Date().toLocaleDateString("es-ES", {day: "numeric",month: "long", year: "numeric",})}

                        Buen dÃ­a alumno	
                        Adjunto: NotificaciÃ³n AprobaciÃ³n de PasantÃ­a y Tutor AcadÃ©mico, Procedimiento y GuÃ­as para el desarrollo de su PasantÃ­a

              En los siguientes enlaces
              Enlace DocumentaciÃ³n PasantÃ­a IINF-Gy

                        https://drive.google.com/drive/folders/1-yydB_0zywTpJgJ3ZS6XybuTvfAKKucM?usp=sharing

              GuÃ­a Normas APA Formato - IINF Gy

                        https://drive.google.com/drive/folders/1aa0u-J8Dm6ZdDBKQg4joRbOPEvqb7XVO?usp=sharing

              EncontrarÃ¡ Las guÃ­as para el desarrollo de la documentaciÃ³n de PasantÃ­a.
              TambiÃ©n se le envÃ­a copia de la designaciÃ³n a su Tutor AcadÃ©mico
              DeseÃ¡ndole el mayor de los Ã©xitos
              Cualquier consulta o duda estoy a su disposiciÃ³n.
              Atentamente, 
              ${this.administratorData.userLastName}, ${this.administratorData.userFirstName}

              ` 
            }

            let emailDataV2: SendEmailRequest = {
              emailTo: this.academicTutorData.userEmail,
              emailFrom: this.administratorData.userEmail,
              subject: `NotificaciÃ³n DesignaciÃ³n Tutor AcadÃ©mico PasantÃ­a y Documentos PasantÃ­a - Alumno ${this.studentData.userLastName.split(" ")[0]}, ${this.studentData.userFirstName.split(" ")[0]}` ,
              htmlContent:
               `
              Puerto Ordaz,  ${new Date().toLocaleDateString("es-ES", {day: "numeric",month: "long", year: "numeric",})}
              Buen dÃ­a Tutor AcadÃ©mico ${this.academicTutorData.userLastName}, ${this.academicTutorData.userFirstName}
              SaludÃ¡ndole cordialmente
              Adjunto 

                        ï	NotificaciÃ³n DesignaciÃ³n Tutor AcadÃ©mico PasantÃ­a 
                        ï	Propuesta de PasantÃ­a aprobado por el Consejo de Escuela
                        ï	Planilla de EvaluaciÃ³n PasantÃ­a Tutor AcadÃ©mico

              Documentos pertinentes para el seguimiento y evaluaciÃ³n de la misma 

                        ï	GuÃ­a ElaboraciÃ³n Informe de PasantÃ­a
                        ï	GuÃ­a Normas APA Formato - IINF Gy

              La NotificaciÃ³n de DesignaciÃ³n, propuesta y Planilla de EvaluaciÃ³n personalizada, de cada alumno, se adjuntan con este documento.

              Las guÃ­as estÃ¡n disponibles en el siguiente enlace:

                        Enlace DocumentaciÃ³n PasantÃ­a IINF-Gy
                        https://drive.google.com/drive/folders/1-yydB_0zywTpJgJ3ZS6XybuTvfAKKucM?usp=sharing

                        GuÃ­a Normas APA Formato - IINF Gy
                        https://drive.google.com/drive/folders/1aa0u-J8Dm6ZdDBKQg4joRbOPEvqb7XVO?usp=sharing

              RecordÃ¡ndole que el proceso de PasantÃ­a es:

                        ï	Seguimiento, cada semana el estudiante debe reportar las actividades y productos obtenidos durante esa semana, utilizando el formato de Informe Actividades PasantÃ­a y usted debe verificarlo. 
                        ï	EvaluaciÃ³n, al finalizar la PasantÃ­a, el estudiante le entregarÃ¡ un informe sobre el trabajo realizado, previa evaluaciÃ³n y aprobaciÃ³n del mismo por el Tutor Empresarial. Este informe debe cumplir con lo estipulado en la GuÃ­a ElaboraciÃ³n Informe de PasantÃ­a y usted debe verificarlo.
                        1. Entrega de informe, por parte de los alumnos
                        los alumnos deben enviarle el informe final de la pasantÃ­a, previa evaluaciÃ³n del Tutor Empresarial, el cual usted revisarÃ¡, en caso de tener alguna observaciÃ³n, se la comunica al alumno.
                        El Tutor Empresarial debe haberle enviado copia de la planilla de evaluaciÃ³n de la PasantÃ­a, en seÃ±al de conformidad con la realizaciÃ³n de la PasantÃ­a y de revisiÃ³n del Informe, sino es asÃ­, por favor comunÃ­quese con Ã©l.
                        2. EvaluaciÃ³n de PasantÃ­a
                        Al estar conforme con el informe, completa la planilla de evaluaciÃ³n personalizada y editable que anexo al presente correo.
                        3. EnvÃ­o de EvaluaciÃ³n de PasantÃ­a
                        EnvÃ­e la planilla de evaluaciÃ³n desde su correo institucional al correo ${this.administratorData.userEmail}, con copia al correo del alumno, para que Ã©l la adjunte en su informe. Cualquier consulta o duda estoy a su disposiciÃ³n
                        Atentamente,
              ${this.administratorData.userLastName}, ${this.administratorData.userFirstName}
              ` 
            }

            console.log(emailData)
            console.log(emailDataV2)
            observables.push(this.emailService.sendEmail(this.studentNotification,emailData))
            observables.push(this.emailService.sendEmail(this.tutorNotification,emailDataV2))
            return forkJoin(observables)
          }
        )
      ).subscribe({
        next: (result: any) => {
          console.log(result)
          const evaluationData: EvaluateIntershipProposalRequest = {
            intershipId: this.inputdata.pasantia.intershipId,
            intershipStatusCode: 20,
            schoolCouncilId: this.pasantiaForm.value.consejoEscuela as string,
            schoolCouncilDecision: 'APROBADA',
            corporateTutorDNI: this.pasantiaForm.value.tutorAcademico as string,
          }

          console.log(evaluationData)
          this.pasantiaService.evaluarPropuestaPasantia(evaluationData).subscribe(
            {
              next: (result) => {
                console.log(result)
              },
              complete: () => {
                this.cargadoArchivos = false
                window.location.href = window.location.href
              }
            }
          )
          
        }
      })

    }else{
      this._snackBar.open("Debe cargar todos los datos", "cerrar",{
        horizontalPosition: this.horizontalPosition,
        verticalPosition: this.verticalPosition,
      })
    }
  }

  descargarPropuestaPasantiaAlumno(){
    console.log(this.studentData)
    const fileName = `${this.studentData.userLastName.split(" ")[0]}${this.studentData.userFirstName.split(" ")[0]} Propuesta PasantÃ­a.pdf`
    let escuela;
    if(this.inputdata.user.schoolName == "Ing. Informatica"){
      escuela = "InformÃ¡tica"
    }else{
      escuela = "Civil"
    }
    descargarPropuestaPasantia(fileName,this.studentData.userDNI, this.studentData.userFirstName,this.studentData.userLastName,escuela)
  }
}
